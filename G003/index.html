<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>三國志将棋</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}

html,body{
  width:100%;height:100%;height:100dvh;
  overflow:hidden;touch-action:none;
}
body{
  font-family:'Hiragino Sans','Yu Gothic','Meiryo',sans-serif;
  background:#f0ede8;color:#3a2a1a;
  display:flex;flex-direction:column;align-items:center;
  -webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
body::before{
  content:'';position:fixed;top:-20px;left:-20px;right:-20px;bottom:-20px;
  background:#f0ede8;
  background-image:
    linear-gradient(45deg,#e5e1da 25%,transparent 25%,transparent 75%,#e5e1da 75%),
    linear-gradient(45deg,#e5e1da 25%,transparent 25%,transparent 75%,#e5e1da 75%);
  background-size:20px 20px;
  background-position:0 0,10px 10px;
  z-index:-1;
  animation:bg-scroll 6s linear infinite;
  will-change:transform;
}
@keyframes bg-scroll{to{transform:translate(20px,20px)}}

#app{
  width:100%;height:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  overflow:hidden;position:relative;z-index:0;
}

/* ── Layout: PC=row, Mobile=column ── */
#game-container{
  display:flex;flex-direction:row;gap:clamp(8px,1.5vw,20px);
  align-items:flex-start;justify-content:center;
  flex:0 0 auto;min-height:0;
  width:100%;overflow:hidden;
  padding:0 4px;
}
#board-section{text-align:center;flex-shrink:0}
#side-panel{display:flex;flex-direction:column;align-items:center;gap:clamp(6px,1vw,12px);flex-shrink:0}
#side-bottom{display:flex;flex-direction:column;align-items:center;flex:1;min-height:0}
#info-panel{text-align:center}
#status{font-size:clamp(13px,3.5vw,17px);min-height:clamp(20px,4vw,26px);color:#b8860b;margin:2px 0;font-weight:bold}

/* ── Board: CSS変数でサイズ制御 ── */
:root{--cs:62px;--bs-font2:22px;--bs-font3:16px;--bs-font1:26px;--bg-w:52px;--bg-h:54px;--dot-sz:16px;--ref-cs:30px;--ref-font:13px}

.hand-area{
  display:flex;align-items:center;justify-content:center;flex-wrap:wrap;
  min-height:clamp(32px,6vw,44px);margin:2px 0;
  background:#f5f0e8;border:1px solid #c4a87a;border-radius:5px;
  padding:2px clamp(4px,1.5vw,10px);gap:clamp(2px,0.8vw,4px)
}
.hand-label{margin-right:clamp(4px,1vw,8px);font-size:clamp(10px,2.5vw,13px);color:#5a4530;font-weight:bold}
.hand-piece{
  padding:clamp(2px,0.5vw,3px) clamp(4px,1vw,7px);
  border:2px solid #bbb;border-radius:4px;cursor:pointer;
  font-size:clamp(11px,3vw,15px);font-weight:bold;transition:all .15s
}
.hand-piece.shu{background:#fbe8e8;color:#c02030}
.hand-piece.wei{background:#e4ecf8;color:#2050b0}
.hand-piece.go{background:#e0f5e8;color:#208040}
.hand-piece.ryofu{background:#f0e8f8;color:#8030a0}
.hand-piece:hover{border-color:#c8960a}
.hand-piece.selected{border-color:#c8960a;box-shadow:0 0 8px #daa520}
.hand-piece .count{font-size:clamp(9px,2vw,11px);color:#555;margin-left:2px}

#board{
  display:grid;
  grid-template-columns:repeat(9,var(--cs));
  grid-template-rows:repeat(9,var(--cs));
  border:3px solid #8b4513;background:#d4a76a;margin:0 auto
}
.col-labels{display:flex;justify-content:center;margin-bottom:1px}
.col-label{width:var(--cs);text-align:center;font-size:clamp(10px,2.5vw,13px);color:#8b7355;font-weight:500}
.board-row-wrap{display:flex;justify-content:center;align-items:stretch}
.row-labels{display:flex;flex-direction:column}
.row-label{height:var(--cs);display:flex;align-items:center;padding-left:2px;font-size:clamp(10px,2.5vw,13px);color:#8b7355}

.cell{
  width:var(--cs);height:var(--cs);
  border:1px solid #8b7355;display:flex;align-items:center;justify-content:center;
  cursor:pointer;position:relative;user-select:none;transition:background .1s;
  -webkit-tap-highlight-color:transparent;
}
.cell:hover{background:rgba(200,170,0,.18)}
.cell.selected{background:rgba(200,150,20,.4)!important}
.cell.last-from{background:rgba(80,130,210,.2)}
.cell.last-to{background:rgba(80,130,210,.3)}
.cell.valid-target{background:rgba(0,180,0,.25)}
.cell.valid-target.has-enemy{background:rgba(200,0,0,.25)}
.cell .dot{position:absolute;width:var(--dot-sz);height:var(--dot-sz);background:rgba(0,140,0,.5);border-radius:50%;pointer-events:none}

.piece-text{
  font-weight:bold;text-align:center;pointer-events:none;
  writing-mode:vertical-rl;text-orientation:upright;letter-spacing:-2px;line-height:1;
  position:relative;z-index:1
}
.piece-text.shu-p{color:#8b1020}
.piece-text.wei-p{color:#1040a0}
.piece-text.go-p{color:#186030}
.piece-text.ryofu-p{color:#602080}
.piece-text.top-side{transform:rotate(180deg)}
.piece-text.sz2{font-size:var(--bs-font2)}
.piece-text.sz3{font-size:var(--bs-font3)}
.piece-text.sz1{font-size:var(--bs-font1)}
.piece-text.promoted{color:#c04010!important}

.piece-bg{
  position:absolute;width:var(--bg-w);height:var(--bg-h);
  clip-path:polygon(50% 2%,95% 18%,95% 98%,5% 98%,5% 18%);pointer-events:none
}
.piece-bg.shu-bg{background:rgba(255,225,185,.92)}
.piece-bg.wei-bg{background:rgba(180,210,255,.85)}
.piece-bg.go-bg{background:rgba(185,240,200,.90)}
.piece-bg.ryofu-bg{background:rgba(220,190,240,.88)}
.piece-bg.top-side{transform:rotate(180deg)}
.king-border{
  position:absolute;width:calc(var(--bg-w) + 6px);height:calc(var(--bg-h) + 4px);
  clip-path:polygon(50% 0%,98% 16%,98% 98%,2% 98%,2% 16%);pointer-events:none;
}
.king-border.shu-king{background:#a02040}
.king-border.wei-king{background:#3060c0}
.king-border.go-king{background:#208040}
.king-border.ryofu-king{background:#8030a0}
.king-border.top-side{transform:rotate(180deg)}
.piece-bg.king-bg{clip-path:polygon(50% 0%,98% 16%,98% 98%,2% 98%,2% 16%)}
.piece-text.king-piece{font-weight:900}

button{
  margin-top:clamp(4px,1vw,12px);padding:clamp(5px,1.5vw,8px) clamp(16px,4vw,28px);
  font-size:clamp(12px,3vw,15px);background:#8b4513;color:#f5ead5;
  border:2px solid #c4a87a;border-radius:5px;cursor:pointer;font-family:inherit;
  -webkit-tap-highlight-color:transparent;
}
button:hover{background:#a0522d}

/* ── Promotion Dialog ── */
#promo-overlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.35);z-index:100;
  align-items:center;justify-content:center;
}
.promo-dialog{
  background:#fff;border:3px solid #c4a87a;border-radius:12px;
  padding:clamp(16px,4vw,24px) clamp(20px,5vw,36px);text-align:center;
  box-shadow:0 4px 20px rgba(0,0,0,.2);
}
.promo-dialog p{font-size:clamp(16px,4vw,22px);color:#3a2a1a;margin-bottom:clamp(12px,3vw,20px)}
.promo-btn{
  margin:0 clamp(4px,1.5vw,10px);padding:clamp(8px,2vw,12px) clamp(16px,4vw,28px);
  font-size:clamp(14px,3.5vw,18px);background:#8b4513;color:#f5ead5;
  border:2px solid #c4a87a;border-radius:8px;cursor:pointer;font-family:inherit;
  -webkit-tap-highlight-color:transparent;
}
.promo-btn:hover{background:#a0522d}

/* ── Result Overlay ── */
#result-overlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0);z-index:200;
  align-items:center;justify-content:center;cursor:pointer;
  flex-direction:column;
}
#result-overlay.show{display:flex}
#result-overlay.win{animation:res-bg-win .6s ease forwards}
#result-overlay.lose{animation:res-bg-lose .8s ease forwards}
@keyframes res-bg-win{to{background:rgba(0,0,0,.55)}}
@keyframes res-bg-lose{to{background:rgba(0,0,0,.7)}}
#result-box{
  opacity:0;
  text-align:center;padding:clamp(20px,5vw,40px) clamp(32px,8vw,64px);
  border-radius:16px;position:relative;
}
#result-overlay.win #result-box{transform:scale(.3);animation:res-pop .5s .3s cubic-bezier(.18,.89,.32,1.28) forwards}
#result-overlay.lose #result-box{transform:translateY(-40px);animation:res-sink .8s .4s ease forwards}
@keyframes res-pop{to{opacity:1;transform:scale(1)}}
@keyframes res-sink{to{opacity:1;transform:translateY(0)}}
#result-name{
  font-size:clamp(36px,10vw,72px);font-weight:900;
  letter-spacing:.08em;
}
#result-sub{
  font-size:clamp(20px,5vw,36px);font-weight:bold;
  letter-spacing:.3em;margin-top:4px;
}
#result-overlay.win #result-name{color:#e03050;text-shadow:0 2px 12px rgba(224,48,80,.4)}
#result-overlay.win #result-sub{color:#f0c0a0;text-shadow:0 1px 6px rgba(0,0,0,.2)}
#result-overlay.lose #result-name{color:#8a8a8a;text-shadow:0 2px 8px rgba(0,0,0,.5)}
#result-overlay.lose #result-sub{color:#666;text-shadow:0 1px 4px rgba(0,0,0,.3)}
#result-particles{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden}
.v-particle{
  position:absolute;width:8px;height:8px;border-radius:50%;opacity:0;
  animation:v-fall linear forwards;
}
@keyframes v-fall{
  0%{opacity:1;transform:translateY(0) rotate(0deg)}
  100%{opacity:0;transform:translateY(100vh) rotate(720deg)}
}
.d-particle{
  position:absolute;bottom:0;width:6px;height:6px;opacity:0;
  animation:d-rise linear forwards;
}
@keyframes d-rise{
  0%{opacity:.6;transform:translateY(0) scale(1)}
  100%{opacity:0;transform:translateY(-60vh) scale(.3)}
}

/* ── Reference Panel ── */
#ref-panel{
  min-width:0;width:clamp(220px,28vw,310px);
  background:#f5f0e8;border:1px solid #c4a87a;border-radius:8px;
  padding:clamp(6px,1vw,12px);text-align:center;
  flex-shrink:0;overflow:hidden;
  display:flex;flex-direction:column;
}
.ref-empty{color:#777;font-size:clamp(11px,2.5vw,14px);padding:6px;line-height:1.8;margin:auto 0}
.ref-title{margin-bottom:4px}
.ref-name{font-size:clamp(16px,3.5vw,22px);font-weight:bold}
.ref-name.shu-p{color:#e03050}
.ref-name.wei-p{color:#4080e0}
.ref-name.go-p{color:#30a060}
.ref-name.ryofu-p{color:#a050d0}
.ref-king-badge{display:inline-block;font-size:clamp(9px,2vw,11px);color:#b8860b;border:1px solid #b8860b;border-radius:3px;padding:0 4px;margin-left:4px;vertical-align:middle}
.ref-desc{font-size:clamp(10px,2.2vw,13px);color:#555;margin-bottom:4px;line-height:1.4;min-height:4.2em}
.ref-fwd{font-size:clamp(9px,2vw,11px);color:#555;margin-bottom:1px}
.ref-board{
  display:grid;
  grid-template-columns:repeat(5,var(--ref-cs));
  grid-template-rows:repeat(5,var(--ref-cs));
  border:2px solid #c4a87a;background:#e8dcc8;margin:0 auto;width:fit-content
}
.ref-cell{
  width:var(--ref-cs);height:var(--ref-cs);
  border:1px solid rgba(160,130,80,.3);display:flex;align-items:center;justify-content:center;
  font-size:clamp(8px,1.8vw,10px);font-weight:bold;color:transparent
}
.ref-cell.ref-center{color:#fff;font-size:var(--ref-font);z-index:1}
.ref-center.ref-shu{background:rgba(180,16,48,.85)}
.ref-center.ref-wei{background:rgba(16,64,160,.85)}
.ref-center.ref-go{background:rgba(32,128,64,.85)}
.ref-center.ref-ryofu{background:rgba(128,48,160,.85)}
.ref-cell.ref-step{background:rgba(230,140,0,.7)}
.ref-cell.ref-slide{background:rgba(220,200,0,.45)}
.ref-cell.ref-knight{background:rgba(0,180,80,.6)}
.ref-legend{display:flex;flex-wrap:wrap;gap:clamp(4px,1vw,8px);justify-content:center;margin-top:clamp(4px,1vw,10px);font-size:clamp(10px,2.2vw,12px);color:#555;min-height:2.4em}
.ref-leg-item{display:flex;align-items:center;gap:2px}
.ref-leg-box{width:clamp(10px,2.5vw,14px);height:clamp(10px,2.5vw,14px);border-radius:2px;display:inline-block}
.ref-leg-box.lg-step{background:rgba(230,140,0,.7)}
.ref-leg-box.lg-slide{background:rgba(220,200,0,.45)}
.ref-leg-box.lg-knight{background:rgba(0,180,80,.6)}
.ref-nocap{font-size:clamp(9px,2vw,11px);color:#c04020;margin-top:4px;font-weight:bold;min-height:1.4em}

/* ── Side Logo ── */
#ref-logo{flex:1;display:flex;align-items:flex-end;justify-content:center;min-height:0;overflow:hidden;padding:4px}
#ref-logo img{width:clamp(140px,22vw,280px);max-height:100%;height:auto;opacity:1;object-fit:contain}

/* ── Title Screen ── */
#title-screen{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  width:100%;height:100%;gap:clamp(20px,5vw,40px);
}
#title-screen>img{width:clamp(200px,40vw,400px);height:auto}
.select-dialog{
  background:#fff;border:3px solid #c4a87a;border-radius:12px;
  padding:clamp(20px,5vw,32px);text-align:center;
  box-shadow:0 4px 20px rgba(0,0,0,.3);max-width:90vw;
}
.select-dialog h2{font-size:clamp(18px,5vw,28px);color:#3a2a1a;margin-bottom:clamp(16px,4vw,24px)}
.select-btns{display:flex;flex-wrap:wrap;gap:clamp(8px,2vw,16px);justify-content:center}
.faction-btn{
  display:flex;flex-direction:column;align-items:center;
  padding:clamp(12px,3vw,20px) clamp(16px,4vw,28px);
  border:3px solid #c4a87a;border-radius:12px;cursor:pointer;
  font-family:inherit;background:#f5f0e8;transition:all .2s;min-width:80px;
  -webkit-tap-highlight-color:transparent;
}
.faction-btn:hover{transform:scale(1.05);box-shadow:0 2px 12px rgba(0,0,0,.15)}
.faction-btn .faction-king{font-size:clamp(20px,5vw,32px);font-weight:900}
.faction-btn .faction-name{font-size:clamp(12px,3vw,16px);color:#555;margin-top:4px}

/* ── Mobile: ボードの下にref+side-bottomが横並び ── */
@media(max-width:850px){
  #game-container{
    flex-direction:column;align-items:center;
    flex:1 1 auto;
    overflow-y:auto;-webkit-overflow-scrolling:touch;
  }
  .col-labels,.row-labels{display:none}
  #side-panel{flex-direction:row;align-items:stretch;width:100%;justify-content:center;gap:clamp(4px,1.5vw,10px)}
  #ref-panel{width:auto;min-width:0;max-width:none;padding:clamp(4px,0.8vw,8px)}
  .ref-desc{display:none}
  .ref-legend{min-height:2em;margin-top:clamp(2px,0.6vw,6px)}
  .ref-nocap{margin-top:2px}
  #side-bottom{flex:1;min-width:0;align-items:center;justify-content:space-between}
  #info-panel{padding-top:4px;text-align:center}
  #ref-logo{flex:1;align-items:flex-end;padding:4px}
  #ref-logo img{max-width:100%;max-height:100%;opacity:1}
}
</style>
</head>
<body>
<div id="app">
  <div id="title-screen">
    <img src="logo.png" alt="三国志将棋">
    <div class="select-dialog">
      <h2 id="select-title">プレイヤー勢力を選択</h2>
      <div class="select-btns" id="select-btns"></div>
    </div>
  </div>
  <div id="game-container" style="display:none">
    <div id="board-section">
      <div class="hand-area" id="top-hand"></div>
      <div class="col-labels" id="col-labels"></div>
      <div class="board-row-wrap">
        <div id="board"></div>
        <div class="row-labels" id="row-labels"></div>
      </div>
      <div class="hand-area" id="bottom-hand"></div>
    </div>
    <div id="side-panel">
      <div id="ref-panel">
        <div class="ref-empty">コマをタッチすると<br>移動範囲を表示します</div>
      </div>
      <div id="side-bottom">
        <div id="info-panel">
          <div id="status"></div>
          <button onclick="initGame();requestAnimationFrame(()=>recalcRefHeight())">新規対局</button>
          <button onclick="showSelectScreen()">終了</button>
        </div>
        <div id="ref-logo"><img src="logo.png" alt="三国志将棋"></div>
      </div>
    </div>
  </div>
</div>
<div id="promo-overlay">
  <div class="promo-dialog">
    <p>成りますか？</p>
    <button class="promo-btn" onclick="resolvePromo(true)">成る</button>
    <button class="promo-btn" onclick="resolvePromo(false)">不成</button>
  </div>
</div>
<div id="result-overlay" onclick="closeResult()">
  <div id="result-particles"></div>
  <div id="result-box">
    <div id="result-name"></div>
    <div id="result-sub"></div>
  </div>
</div>
<script>
// ═══════════════════════════════════════════
//  三國志将棋 - Game Engine
// ═══════════════════════════════════════════

const SZ = 9;

const PT = {
  ryubi:   {n:'劉備', m:['cross'],                k:true,  v:9999},
  kannu:   {n:'関羽', m:['rook','king'],           k:false, v:1200, nc:true},
  chohi:   {n:'張飛', m:['bishop','lance'],        k:false, v:900,  nc:true},
  chouun:  {n:'趙雲', m:['rook'],                  k:false, v:800,  nc:true},
  kouchuu: {n:'黄忠', m:['rook'],                  k:false, v:800},
  bachou:  {n:'馬超', m:['bishop'],                k:false, v:700},
  koumei:  {n:'孔明', m:['king','knight'],         k:false, v:700,  nc:true},
  houtou:  {n:'龐統', m:['king','knight'],         k:false, v:700},
  sousou:  {n:'曹操', m:['king','knight','lance'], k:true,  v:9999},
  kakuka:  {n:'郭嘉', m:['king'],                  k:false, v:500},
  juniku:  {n:'荀彧', m:['king'],                  k:false, v:500},
  junyuu:  {n:'荀攸', m:['silver'],                k:false, v:400},
  teiiku:  {n:'程昱', m:['silver'],                k:false, v:400},
  kakouton:{n:'夏侯惇',m:['rook'],                 k:false, v:800,  nc:true},
  kakouen: {n:'夏侯淵',m:['bishop'],               k:false, v:700,  nc:true},
  churyou: {n:'張遼', m:['bishop'],                k:false, v:700},
  kyocho:  {n:'許褚', m:['rook'],                  k:false, v:800,  nc:true},
  jokou:   {n:'徐晃', m:['rook'],                  k:false, v:800},
  sonken:  {n:'孫権', m:['king','knight'],           k:true,  v:9999},
  kannei:  {n:'甘寧', m:['bishop'],                 k:false, v:700},
  ryomou:  {n:'呂蒙', m:['king','rook'],             k:false, v:900,  nc:true},
  shuyu:   {n:'周瑜', m:['king','bishop'],           k:false, v:850,  nc:true},
  roshuku: {n:'魯粛', m:['king'],                    k:false, v:600},
  rikuson: {n:'陸遜', m:['king','bishop'],           k:false, v:850,  nc:true},
  kougai:  {n:'黄蓋', m:['rook'],                    k:false, v:800},
  ryofu_k: {n:'呂布', m:['rook','bishop','knight'],k:true,  v:9999},
  chinkyuu:{n:'陳宮', m:['king'],                  k:false, v:600,  nc:true},
  fu:      {n:'歩',   m:['pawn'],                  k:false, v:100},
  fu_p:    {n:'と金', m:['gold'],                  k:false, v:400},
};

// ─── Faction Definitions ───
const FACTIONS = {
  shu:  {name:'蜀', king:'劉備', kingType:'ryubi',  color:'#c02030',
         layout:[
           {col:5,row:9,type:'ryubi'},{col:4,row:9,type:'kannu'},{col:6,row:9,type:'chohi'},
           {col:5,row:8,type:'chouun'},{col:4,row:8,type:'kouchuu'},{col:6,row:8,type:'bachou'},
           {col:3,row:9,type:'koumei'},{col:7,row:9,type:'houtou'},
           {col:3,row:7,type:'fu'},{col:4,row:7,type:'fu'},{col:5,row:7,type:'fu'},
           {col:6,row:7,type:'fu'},{col:7,row:7,type:'fu'}
         ]},
  wei:  {name:'魏', king:'曹操', kingType:'sousou', color:'#2050b0',
         layout:[
           {col:5,row:9,type:'sousou'},{col:4,row:9,type:'kakuka'},{col:6,row:9,type:'juniku'},
           {col:3,row:9,type:'junyuu'},{col:7,row:9,type:'teiiku'},
           {col:2,row:8,type:'kakouton'},{col:8,row:8,type:'kakouen'},{col:1,row:8,type:'churyou'},
           {col:5,row:8,type:'kyocho'},{col:9,row:8,type:'jokou'},
           {col:3,row:7,type:'fu'},{col:4,row:7,type:'fu'},{col:5,row:7,type:'fu'},
           {col:6,row:7,type:'fu'},{col:7,row:7,type:'fu'}
         ]},
  go:   {name:'呉', king:'孫権', kingType:'sonken', color:'#208040',
         layout:[
           {col:5,row:9,type:'sonken'},{col:4,row:9,type:'roshuku'},{col:6,row:9,type:'shuyu'},
           {col:3,row:9,type:'rikuson'},{col:7,row:9,type:'ryomou'},
           {col:3,row:8,type:'kougai'},{col:7,row:8,type:'kannei'},
           {col:3,row:7,type:'fu'},{col:4,row:7,type:'fu'},{col:5,row:7,type:'fu'},
           {col:6,row:7,type:'fu'},{col:7,row:7,type:'fu'}
         ]},
  ryofu:{name:'呂布', king:'呂布', kingType:'ryofu_k', color:'#8030a0',
         layout:[
           {col:5,row:9,type:'ryofu_k'},{col:4,row:9,type:'chinkyuu'}
         ]}
};

// Promotion mappings
const PROMOTE_MAP = {fu:'fu_p'};
const DEMOTE_MAP = {fu_p:'fu'};
function canPromote(type){return type in PROMOTE_MAP;}
function inPromoZone(row,owner){return owner===playerFaction?row<=2:row>=6;}
function mustPromote(type,row,owner){if(type==='fu')return owner===playerFaction?row===0:row===8;return false;}
function baseType(type){return DEMOTE_MAP[type]||type;}

// Movement type descriptions
const MOVE_DESC = {
  cross:'十字（上下左右１マス）', king:'王（全方向１マス）',
  rook:'飛車（縦横何マスでも）', bishop:'角行（斜め何マスでも）',
  knight:'桂馬（前方にL字跳び）', lance:'香車（前方何マスでも）',
  gold:'金将（前・横・後ろ）', silver:'銀将（前・斜め）',
  pawn:'歩兵（前方１マス）'
};

// ─── Game State ───
let board, hands, turn, selCell, selHand, targets, gameOver, winner, lastFrom, lastTo;
let refType = null, refOwner = null;
let pendingPromo = null;
let playerFaction = 'shu', aiFaction = 'wei';

// ─── Responsive Sizing ───
function resizeBoard() {
  const isMobile = window.innerWidth <= 850;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const r = document.documentElement;

  if (isMobile) {
    const availW = vw - 14;
    const csRaw = Math.max(28, Math.min(62, Math.floor(availW / 9)));
    const cs = Math.max(26, Math.floor(csRaw * 0.94));
    r.style.setProperty('--cs', cs + 'px');
    r.style.setProperty('--bs-font2', Math.max(12, Math.round(cs * 0.35)) + 'px');
    r.style.setProperty('--bs-font3', Math.max(9, Math.round(cs * 0.26)) + 'px');
    r.style.setProperty('--bs-font1', Math.max(14, Math.round(cs * 0.42)) + 'px');
    r.style.setProperty('--bg-w', Math.round(cs * 0.84) + 'px');
    r.style.setProperty('--bg-h', Math.round(cs * 0.87) + 'px');
    r.style.setProperty('--dot-sz', Math.max(8, Math.round(cs * 0.26)) + 'px');
    const refCs = Math.max(14, Math.min(26, Math.floor((vw - 40) / 9)));
    r.style.setProperty('--ref-cs', refCs + 'px');
    r.style.setProperty('--ref-font', Math.max(8, Math.round(refCs * 0.43)) + 'px');
  } else {
    r.style.setProperty('--cs', '62px');
    r.style.setProperty('--bs-font2', '22px');
    r.style.setProperty('--bs-font3', '16px');
    r.style.setProperty('--bs-font1', '26px');
    r.style.setProperty('--bg-w', '52px');
    r.style.setProperty('--bg-h', '54px');
    r.style.setProperty('--dot-sz', '16px');
    r.style.setProperty('--ref-cs', '30px');
    r.style.setProperty('--ref-font', '13px');
  }
}

let refPanelWidth = 0;
function recalcRefHeight(){
  const p=document.getElementById('ref-panel');
  if(!p)return;
  const saved={t:refType,o:refOwner};
  refPanelHeight=0; refPanelWidth=0;
  p.style.height=''; p.style.width='';
  // 曹操(desc最多)、関羽(nocap)、呂布(3移動タイプ)を測定し大きい方を採用
  for(const t of ['sousou','kannu','ryofu_k']){
    refType=t; refOwner=aiFaction;
    renderMoveRef();
    if(p.offsetHeight>refPanelHeight) refPanelHeight=p.offsetHeight;
    if(p.offsetWidth>refPanelWidth) refPanelWidth=p.offsetWidth;
  }
  p.style.height=refPanelHeight+'px';
  p.style.width=refPanelWidth+'px';
  refType=saved.t; refOwner=saved.o;
  renderMoveRef();
  if(window.innerWidth>850){
    const bs=document.getElementById('board-section');
    const sp=document.getElementById('side-panel');
    if(bs&&sp){sp.style.height=bs.offsetHeight+'px';}
  } else {
    const sp=document.getElementById('side-panel');
    if(sp) sp.style.height='';
  }
}
window.addEventListener('resize', ()=>{resizeBoard();recalcRefHeight();});
window.addEventListener('orientationchange', ()=>setTimeout(()=>{resizeBoard();recalcRefHeight();},200));

// ─── Board Initialization ───
function initGame() {
  board = Array.from({length:SZ}, () => Array(SZ).fill(null));
  hands = {};
  hands[playerFaction] = [];
  hands[aiFaction] = [];
  turn = playerFaction; selCell = null; selHand = null; targets = [];
  gameOver = false; winner = null; lastFrom = null; lastTo = null;
  refType = null; refOwner = null; pendingPromo = null;
  resultShown = false; closeResult();

  // Player pieces (bottom side)
  for(const p of FACTIONS[playerFaction].layout){
    board[p.row-1][9-p.col] = {type:p.type, owner:playerFaction};
  }
  // AI pieces (top side, mirrored)
  for(const p of FACTIONS[aiFaction].layout){
    board[10-p.row-1][9-(10-p.col)] = {type:p.type, owner:aiFaction};
  }

  document.title = '三國志将棋 - ' + FACTIONS[playerFaction].name + ' vs ' + FACTIONS[aiFaction].name;
  render();
  renderMoveRef();
}

// ═══════════════════════════════════════════
//  Move Generation
// ═══════════════════════════════════════════

function fwd(owner) { return owner === playerFaction ? -1 : 1; }

function genMoves(type, r, c, owner) {
  const piece = PT[type]; const f = fwd(owner);
  const mvs = []; const seen = new Set();
  function add(nr, nc) {
    if (nr<0||nr>=SZ||nc<0||nc>=SZ) return false;
    const t=board[nr][nc]; if(t&&t.owner===owner) return false;
    const key=nr*SZ+nc;
    if(!seen.has(key)){seen.add(key); mvs.push({r:nr,c:nc});}
    return !t;
  }
  function step(o){for(const[dr,dc]of o)add(r+dr,c+dc);}
  function slide(d){for(const[dr,dc]of d)for(let i=1;i<SZ;i++)if(!add(r+dr*i,c+dc*i))break;}
  for(const mt of piece.m){
    switch(mt){
      case'cross':step([[0,1],[0,-1],[1,0],[-1,0]]);break;
      case'king':step([[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]);break;
      case'rook':slide([[0,1],[0,-1],[1,0],[-1,0]]);break;
      case'bishop':slide([[1,1],[1,-1],[-1,1],[-1,-1]]);break;
      case'knight':step([[f*2,-1],[f*2,1]]);break;
      case'lance':slide([[f,0]]);break;
      case'gold':step([[f,0],[f,-1],[f,1],[0,-1],[0,1],[-f,0]]);break;
      case'silver':step([[f,0],[f,-1],[f,1],[-f,-1],[-f,1]]);break;
      case'pawn':step([[f,0]]);break;
    }
  }
  return mvs;
}

// ═══════════════════════════════════════════
//  Check Detection & Legal Moves
// ═══════════════════════════════════════════

function findKing(owner){
  for(let r=0;r<SZ;r++)for(let c=0;c<SZ;c++)
    if(board[r][c]&&board[r][c].owner===owner&&PT[board[r][c].type].k)return{r,c};
  return null;
}
function inCheck(owner){
  const kp=findKing(owner);if(!kp)return true;
  const opp=owner===playerFaction?aiFaction:playerFaction;
  for(let r=0;r<SZ;r++)for(let c=0;c<SZ;c++)
    if(board[r][c]&&board[r][c].owner===opp){
      if(genMoves(board[r][c].type,r,c,opp).some(m=>m.r===kp.r&&m.c===kp.c))return true;
    }
  return false;
}
function legalMoves(r,c){
  const pc=board[r][c];if(!pc)return[];
  return genMoves(pc.type,r,c,pc.owner).filter(m=>{
    const cap=board[m.r][m.c];board[m.r][m.c]=pc;board[r][c]=null;
    const chk=inCheck(pc.owner);board[r][c]=pc;board[m.r][m.c]=cap;return!chk;
  });
}
function legalDrops(type,owner){
  const sq=[];
  for(let r=0;r<SZ;r++)for(let c=0;c<SZ;c++){
    if(board[r][c])continue;
    if(type==='fu'){
      if((owner===playerFaction&&r===0)||(owner===aiFaction&&r===8))continue;
      let nifu=false;for(let rr=0;rr<SZ;rr++)if(board[rr][c]&&board[rr][c].type==='fu'&&board[rr][c].owner===owner){nifu=true;break;}
      if(nifu)continue;
    }
    board[r][c]={type,owner};const chk=inCheck(owner);board[r][c]=null;
    if(!chk)sq.push({r,c});
  }
  return sq;
}
function allLegalMoves(player,includeDrops){
  const mvs=[];
  for(let r=0;r<SZ;r++)for(let c=0;c<SZ;c++)
    if(board[r][c]&&board[r][c].owner===player){
      const pc=board[r][c];
      for(const m of legalMoves(r,c)){
        const cp=canPromote(pc.type);
        const inZ=cp&&(inPromoZone(r,player)||inPromoZone(m.r,player));
        const must=cp&&mustPromote(pc.type,m.r,player);
        if(inZ){mvs.push({t:'move',fr:r,fc:c,tr:m.r,tc:m.c,promote:true});if(!must)mvs.push({t:'move',fr:r,fc:c,tr:m.r,tc:m.c,promote:false});}
        else mvs.push({t:'move',fr:r,fc:c,tr:m.r,tc:m.c,promote:false});
      }
    }
  if(includeDrops!==false){
    const unique=[...new Set(hands[player])];
    for(const pt of unique)for(const d of legalDrops(pt,player))
      mvs.push({t:'drop',pt,tr:d.r,tc:d.c,owner:player});
  }
  return mvs;
}
function isCheckmate(p){return inCheck(p)&&allLegalMoves(p,true).length===0;}
function hasNoMoves(p){return allLegalMoves(p,true).length===0;}

// ═══════════════════════════════════════════
//  Move Execution (with undo)
// ═══════════════════════════════════════════

function doMove(mv){
  const undo={mv};
  if(mv.t==='move'){
    undo.srcPc=board[mv.fr][mv.fc];undo.dstPc=board[mv.tr][mv.tc];undo.captured=null;
    if(undo.dstPc&&!PT[undo.dstPc.type].k){
      if(PT[baseType(undo.dstPc.type)].nc){undo.captured=null;}
      else{const capT=baseType(undo.dstPc.type);hands[undo.srcPc.owner].push(capT);undo.captured={type:capT,hand:undo.srcPc.owner};}
    }
    const movedPc=mv.promote?{type:PROMOTE_MAP[undo.srcPc.type],owner:undo.srcPc.owner}:undo.srcPc;
    board[mv.tr][mv.tc]=movedPc;board[mv.fr][mv.fc]=null;
  }else{
    undo.dstPc=null;const idx=hands[mv.owner].indexOf(mv.pt);
    undo.handIdx=idx;hands[mv.owner].splice(idx,1);
    board[mv.tr][mv.tc]={type:mv.pt,owner:mv.owner};
  }
  return undo;
}
function undoMove(undo){
  const mv=undo.mv;
  if(mv.t==='move'){
    board[mv.fr][mv.fc]=undo.srcPc;board[mv.tr][mv.tc]=undo.dstPc;
    if(undo.captured){const h=hands[undo.captured.hand];h.splice(h.lastIndexOf(undo.captured.type),1);}
  }else{board[mv.tr][mv.tc]=null;hands[mv.owner].splice(undo.handIdx,0,mv.pt);}
}

// ═══════════════════════════════════════════
//  AI (Minimax with Alpha-Beta, 2-ply)
// ═══════════════════════════════════════════

function evaluate(){
  let playerK=false,aiK=false,score=0;
  for(let r=0;r<SZ;r++)for(let c=0;c<SZ;c++){
    const p=board[r][c];if(!p)continue;
    if(PT[p.type].k){if(p.owner===playerFaction)playerK=true;else aiK=true;continue;}
    const v=PT[p.type].v;
    if(p.owner===aiFaction){score+=v+r*3;}else{score-=v+(8-r)*3;}
  }
  if(!playerK)return 99999;if(!aiK)return-99999;
  for(const t of hands[aiFaction])score+=PT[t].v*0.8;
  for(const t of hands[playerFaction])score-=PT[t].v*0.8;
  if(inCheck(playerFaction))score+=150;if(inCheck(aiFaction))score-=150;
  return score;
}
function orderMoves(mvs){
  return mvs.sort((a,b)=>{
    let sa=0,sb=0;
    if(a.t==='move'&&board[a.tr][a.tc])sa=PT[board[a.tr][a.tc].type].v;
    if(b.t==='move'&&board[b.tr][b.tc])sb=PT[board[b.tr][b.tc].type].v;
    return sb-sa;
  });
}
function minimax(depth,alpha,beta,maximizing){
  if(depth===0)return evaluate();
  const player=maximizing?aiFaction:playerFaction;
  const mvs=orderMoves(allLegalMoves(player,false));
  if(mvs.length===0)return inCheck(player)?(maximizing?-90000+depth:90000-depth):0;
  if(maximizing){let best=-Infinity;for(const mv of mvs){const u=doMove(mv);best=Math.max(best,minimax(depth-1,alpha,beta,false));undoMove(u);alpha=Math.max(alpha,best);if(beta<=alpha)break;}return best;}
  else{let best=Infinity;for(const mv of mvs){const u=doMove(mv);best=Math.min(best,minimax(depth-1,alpha,beta,true));undoMove(u);beta=Math.min(beta,best);if(beta<=alpha)break;}return best;}
}
function aiTurn(){
  if(gameOver)return;
  const mvs=allLegalMoves(aiFaction,true);
  if(mvs.length===0){gameOver=true;winner=playerFaction;render();return;}
  let bestScore=-Infinity,bestMvs=[];
  for(const mv of orderMoves(mvs)){
    const u=doMove(mv);const sc=minimax(1,-Infinity,Infinity,false);undoMove(u);
    if(sc>bestScore){bestScore=sc;bestMvs=[mv];}else if(sc===bestScore){bestMvs.push(mv);}
  }
  const chosen=bestMvs[Math.floor(Math.random()*bestMvs.length)];
  doMove(chosen);
  lastFrom=chosen.t==='move'?{r:chosen.fr,c:chosen.fc}:null;
  lastTo={r:chosen.tr,c:chosen.tc};
  if(isCheckmate(playerFaction)){gameOver=true;winner=aiFaction;}
  else if(hasNoMoves(playerFaction)){gameOver=true;winner=aiFaction;}
  turn=playerFaction;render();
}

// ═══════════════════════════════════════════
//  Movement Reference Panel
// ═══════════════════════════════════════════

function genMovePattern(type) {
  const S=5, C=2;
  const g = Array.from({length:S}, () => Array(S).fill(0));
  g[C][C] = 4;
  const f = -1;
  const piece = PT[type];

  function markStep(dr,dc) {
    const r=C+dr,c=C+dc;
    if(r>=0&&r<S&&c>=0&&c<S&&g[r][c]!==4) g[r][c]=1;
  }
  function markSlide(dr,dc) {
    for(let i=1;i<S;i++){const r=C+dr*i,c=C+dc*i;
      if(r<0||r>=S||c<0||c>=S)break;
      if(g[r][c]===0) g[r][c]=2;
    }
  }
  function markKnight(dr,dc) {
    const r=C+dr,c=C+dc;
    if(r>=0&&r<S&&c>=0&&c<S&&g[r][c]===0) g[r][c]=3;
  }

  for (const mt of piece.m) {
    switch(mt) {
      case 'cross':
        markStep(0,1);markStep(0,-1);markStep(1,0);markStep(-1,0);break;
      case 'king':
        markStep(0,1);markStep(0,-1);markStep(1,0);markStep(-1,0);
        markStep(1,1);markStep(1,-1);markStep(-1,1);markStep(-1,-1);break;
      case 'rook':
        markSlide(0,1);markSlide(0,-1);markSlide(1,0);markSlide(-1,0);break;
      case 'bishop':
        markSlide(1,1);markSlide(1,-1);markSlide(-1,1);markSlide(-1,-1);break;
      case 'knight':
        markKnight(f*2,-1);markKnight(f*2,1);break;
      case 'lance':
        markSlide(f,0);break;
      case 'gold':
        markStep(f,0);markStep(f,-1);markStep(f,1);markStep(0,-1);markStep(0,1);markStep(-f,0);break;
      case 'silver':
        markStep(f,0);markStep(f,-1);markStep(f,1);markStep(-f,-1);markStep(-f,1);break;
      case 'pawn':
        markStep(f,0);break;
    }
  }
  return g;
}

let refPanelHeight = 0;
function renderMoveRef() {
  const panel = document.getElementById('ref-panel');
  if (!refType) {
    panel.innerHTML = '<div class="ref-empty">コマをタッチすると<br>移動範囲を表示します</div>';
    return;
  }
  const piece = PT[refType];
  const factionClass = refOwner + '-p';
  const refCenterClass = 'ref-' + refOwner;
  const grid = genMovePattern(refType);

  let h = '<div class="ref-title">';
  h += '<span class="ref-name '+factionClass+'">'+piece.n+'</span>';
  if (piece.k) h += '<span class="ref-king-badge">王将</span>';
  if (refType in DEMOTE_MAP) h += '<span class="ref-king-badge" style="color:#ff6600;border-color:#ff6600">成</span>';
  h += '</div>';

  h += '<div class="ref-desc">';
  h += piece.m.map(mt => MOVE_DESC[mt]).join('<br>');
  h += '</div>';

  h += '<div class="ref-fwd">▲ 前方</div>';

  h += '<div class="ref-board">';
  for (let r = 0; r < 5; r++) {
    for (let c = 0; c < 5; c++) {
      let cls = 'ref-cell';
      let content = '';
      switch(grid[r][c]) {
        case 4:
          cls += ' ref-center '+refCenterClass;
          content = piece.n.substring(0,1);
          break;
        case 1: cls += ' ref-step'; break;
        case 2: cls += ' ref-slide'; break;
        case 3: cls += ' ref-knight'; break;
      }
      h += '<div class="'+cls+'">'+content+'</div>';
    }
  }
  h += '</div>';

  h += '<div class="ref-legend">';
  const hasSlide = piece.m.some(m=>['rook','bishop','lance'].includes(m));
  const hasKnight = piece.m.includes('knight');
  h += '<span class="ref-leg-item"><span class="ref-leg-box lg-step"></span>１マス</span>';
  if (hasSlide) h += '<span class="ref-leg-item"><span class="ref-leg-box lg-slide"></span>何マスでも</span>';
  if (hasKnight) h += '<span class="ref-leg-item"><span class="ref-leg-box lg-knight"></span>桂馬跳び</span>';
  h += '</div>';

  if (PT[baseType(refType)].nc) {
    h += '<div class="ref-nocap">※ 持ち駒不可（取っても持駒にならない）</div>';
  } else {
    h += '<div class="ref-nocap"></div>';
  }

  panel.innerHTML = h;
}

// ═══════════════════════════════════════════
//  UI Rendering
// ═══════════════════════════════════════════

function render() {
  renderBoard(); renderHand(playerFaction); renderHand(aiFaction); renderStatus(); renderLabels();
}

function renderLabels() {
  const cl = document.getElementById('col-labels');
  if (!cl.children.length) {
    let h='';for(let c=0;c<SZ;c++)h+='<div class="col-label">'+(9-c)+'</div>';cl.innerHTML=h;
  }
  const rl = document.getElementById('row-labels');
  if (!rl.children.length) {
    const rows='一二三四五六七八九';let h='';
    for(let r=0;r<SZ;r++)h+='<div class="row-label">'+rows[r]+'</div>';rl.innerHTML=h;
  }
}

function renderBoard() {
  const el = document.getElementById('board');
  let html = '';
  for (let r=0;r<SZ;r++) {
    for (let c=0;c<SZ;c++) {
      const pc=board[r][c]; let cls='cell';
      if(selCell&&selCell.r===r&&selCell.c===c) cls+=' selected';
      if(lastFrom&&lastFrom.r===r&&lastFrom.c===c) cls+=' last-from';
      if(lastTo&&lastTo.r===r&&lastTo.c===c) cls+=' last-to';
      const isTarget=targets.some(t=>t.r===r&&t.c===c);
      if(isTarget){cls+=' valid-target';if(pc)cls+=' has-enemy';}
      html+='<div class="'+cls+'" onclick="clickCell('+r+','+c+')">';
      if(pc){
        const name=PT[pc.type].n;
        const isKing=PT[pc.type].k;
        const isAi=pc.owner===aiFaction;
        const oc=pc.owner+'-p';
        const bg=pc.owner+'-bg';
        const rot=isAi?' top-side':'';
        const sz=name.length>=3?'sz3':name.length===1?'sz1':'sz2';
        const prm=pc.type in DEMOTE_MAP?' promoted':'';
        const kc=isKing?' king-bg':'';
        const kw=isKing?' king-piece':'';
        if(isKing) html+='<div class="king-border '+pc.owner+'-king'+rot+'"></div>';
        html+='<div class="piece-bg '+bg+kc+rot+'"></div>';
        html+='<div class="piece-text '+oc+' '+sz+prm+kw+rot+'">'+name+'</div>';
      } else if(isTarget) { html+='<div class="dot"></div>'; }
      html+='</div>';
    }
  }
  el.innerHTML = html;
}

function renderHand(owner) {
  const isPlayer = owner===playerFaction;
  const el=document.getElementById(isPlayer?'bottom-hand':'top-hand');
  const fData=FACTIONS[owner];
  const label='【'+fData.name+' 持駒】';
  let html='<span class="hand-label">'+label+'</span>';
  const counts={};for(const t of hands[owner])counts[t]=(counts[t]||0)+1;
  if(Object.keys(counts).length===0) html+='<span style="color:#888;font-size:clamp(10px,2.5vw,13px)">なし</span>';
  for(const[type,cnt]of Object.entries(counts)){
    const cls=owner;
    const sel=(selHand===type&&turn===owner)?' selected':'';
    const click=(isPlayer&&turn===playerFaction&&!gameOver)?' onclick="clickHand(\''+type+'\')"':'';
    html+='<span class="hand-piece '+cls+sel+'"'+click+'>'+PT[type].n;
    if(cnt>1)html+='<span class="count">x'+cnt+'</span>';
    html+='</span>';
  }
  el.innerHTML=html;
}

let resultShown=false;
function renderStatus() {
  const el=document.getElementById('status');
  const pf=FACTIONS[playerFaction];
  const af=FACTIONS[aiFaction];
  if(gameOver){
    const isWin=winner===playerFaction;
    el.textContent=pf.king+(isWin?' 勝利！':' 敗北！');
    el.style.color=isWin?pf.color:'#666';
    if(!resultShown){resultShown=true;setTimeout(()=>showResult(isWin),300);}
    return;
  }
  if(turn===aiFaction){el.textContent=af.name+'が考えています...';el.style.color=af.color;}
  else{el.textContent=pf.name+'のターンです'+(inCheck(playerFaction)?' 【王手！】':'');el.style.color='#b8860b';}
}

// ═══════════════════════════════════════════
//  Result
// ═══════════════════════════════════════════

function showResult(isWin){
  const ov=document.getElementById('result-overlay');
  ov.style.display='';
  ov.className='show '+(isWin?'win':'lose');
  document.getElementById('result-name').textContent=FACTIONS[playerFaction].king;
  document.getElementById('result-sub').textContent=isWin?'勝 利':'敗 北';
  const pc=document.getElementById('result-particles');
  pc.innerHTML='';
  if(isWin){
    const colors=['#e03050','#ff6b6b','#ffd700','#ff8c50'];
    for(let i=0;i<40;i++){
      const d=document.createElement('div');d.className='v-particle';
      d.style.left=Math.random()*100+'%';
      d.style.top=-10-Math.random()*20+'%';
      d.style.width=d.style.height=4+Math.random()*8+'px';
      d.style.background=colors[Math.floor(Math.random()*colors.length)];
      d.style.borderRadius=Math.random()>.5?'50%':'2px';
      d.style.animationDuration=1.5+Math.random()*2+'s';
      d.style.animationDelay=Math.random()*1.2+'s';
      pc.appendChild(d);
    }
  } else {
    const colors=['#555','#777','#444','#666'];
    for(let i=0;i<20;i++){
      const d=document.createElement('div');d.className='d-particle';
      d.style.left=Math.random()*100+'%';
      d.style.width=d.style.height=3+Math.random()*6+'px';
      d.style.background=colors[Math.floor(Math.random()*colors.length)];
      d.style.borderRadius=Math.random()>.5?'50%':'1px';
      d.style.animationDuration=2+Math.random()*3+'s';
      d.style.animationDelay=.5+Math.random()*1.5+'s';
      pc.appendChild(d);
    }
  }
}
function closeResult(){
  const ov=document.getElementById('result-overlay');
  ov.className='';ov.style.display='none';
}

// ═══════════════════════════════════════════
//  Selection Screen
// ═══════════════════════════════════════════

function showSelectScreen(){
  document.getElementById('title-screen').style.display='';
  document.getElementById('game-container').style.display='none';
  const title=document.getElementById('select-title');
  const btns=document.getElementById('select-btns');
  title.textContent='プレイヤー勢力を選択';
  btns.innerHTML='';
  for(const[id,f] of Object.entries(FACTIONS)){
    const btn=document.createElement('div');
    btn.className='faction-btn';
    btn.style.borderColor=f.color;
    btn.innerHTML='<div class="faction-king" style="color:'+f.color+'">'+f.king+'</div>'
                 +'<div class="faction-name">'+f.name+'</div>';
    btn.onclick=()=>selectPlayerFaction(id);
    btns.appendChild(btn);
  }
}

function selectPlayerFaction(factionId){
  playerFaction=factionId;
  const title=document.getElementById('select-title');
  const btns=document.getElementById('select-btns');
  title.textContent='対戦相手を選択';
  btns.innerHTML='';
  for(const[id,f] of Object.entries(FACTIONS)){
    if(id===playerFaction) continue;
    const btn=document.createElement('div');
    btn.className='faction-btn';
    btn.style.borderColor=f.color;
    btn.innerHTML='<div class="faction-king" style="color:'+f.color+'">'+f.king+'</div>'
                 +'<div class="faction-name">'+f.name+'</div>';
    btn.onclick=()=>selectAiFaction(id);
    btns.appendChild(btn);
  }
}

function selectAiFaction(factionId){
  aiFaction=factionId;
  document.getElementById('title-screen').style.display='none';
  document.getElementById('game-container').style.display='';
  initGame();
  requestAnimationFrame(()=>recalcRefHeight());
}

// ═══════════════════════════════════════════
//  Event Handlers
// ═══════════════════════════════════════════

function clearSelection(){selCell=null;selHand=null;targets=[];}

function showRef(type, owner) {
  refType = type; refOwner = owner;
  renderMoveRef();
}

function executeMove(fr,fc,tr,tc,promote){
  doMove({t:'move',fr,fc,tr,tc,promote});
  lastFrom={r:fr,c:fc};lastTo={r:tr,c:tc};clearSelection();
  if(isCheckmate(aiFaction)){gameOver=true;winner=playerFaction;}
  else if(hasNoMoves(aiFaction)){gameOver=true;winner=playerFaction;}
  turn=aiFaction;render();if(!gameOver)setTimeout(aiTurn,200);
}
function executeDrop(type,r,c){
  doMove({t:'drop',pt:type,tr:r,tc:c,owner:playerFaction});
  lastFrom=null;lastTo={r,c};clearSelection();
  if(isCheckmate(aiFaction)){gameOver=true;winner=playerFaction;}
  else if(hasNoMoves(aiFaction)){gameOver=true;winner=playerFaction;}
  turn=aiFaction;render();if(!gameOver)setTimeout(aiTurn,200);
}
function showPromoDialog(){document.getElementById('promo-overlay').style.display='flex';}
function resolvePromo(doP){
  document.getElementById('promo-overlay').style.display='none';
  if(pendingPromo){executeMove(pendingPromo.fr,pendingPromo.fc,pendingPromo.tr,pendingPromo.tc,doP);pendingPromo=null;}
}

function clickCell(r, c) {
  if(pendingPromo)return;
  const pcAt = board[r][c];
  if (pcAt) showRef(pcAt.type, pcAt.owner);

  if (gameOver || turn !== playerFaction) return;

  if (targets.some(t=>t.r===r&&t.c===c)) {
    if (selCell) {
      const srcPc=board[selCell.r][selCell.c];
      const cp=canPromote(srcPc.type);
      const inZ=cp&&(inPromoZone(selCell.r,playerFaction)||inPromoZone(r,playerFaction));
      if(inZ){
        if(mustPromote(srcPc.type,r,playerFaction)){executeMove(selCell.r,selCell.c,r,c,true);}
        else{pendingPromo={fr:selCell.r,fc:selCell.c,tr:r,tc:c};showPromoDialog();}
      }else{executeMove(selCell.r,selCell.c,r,c,false);}
      return;
    }
    if (selHand) {
      executeDrop(selHand,r,c);
      return;
    }
  }

  if (pcAt && pcAt.owner === playerFaction) {
    selHand=null;
    if(selCell&&selCell.r===r&&selCell.c===c){clearSelection();}
    else{selCell={r,c};targets=legalMoves(r,c);}
    render();return;
  }
  clearSelection();render();
}

function clickHand(type) {
  if(pendingPromo)return;
  if(gameOver||turn!==playerFaction)return;
  showRef(type, playerFaction);
  selCell=null;
  if(selHand===type){clearSelection();}
  else{selHand=type;targets=legalDrops(type,playerFaction);}
  render();
}

// ═══════════════════════════════════════════
//  Start
// ═══════════════════════════════════════════
resizeBoard();
showSelectScreen();
</script>
</body>
</html>
